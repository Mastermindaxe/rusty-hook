trigger:
- master

pr:
- master

pool:
  vmImage: win1803

steps:
- script: |
    curl -sSf -o rustup-init.exe https://win.rustup.rs
    rustup-init.exe -y
    echo "##vso[task.setvariable variable=PATH;]%PATH%;%USERPROFILE%\.cargo\bin"
    echo "##vso[task.setvariable variable=cargoBinPath;]%USERPROFILE%\.cargo\bin"
  displayName: 'Install Rust'

- task: DownloadPipelineArtifact@0
  displayName: 'Download cargo-junit executable'
  inputs:
    pipelineId: 1386
    artifactName: 'cargo-junit'
    targetPath: '$(cargoBinPath)'

- script: |
    mkdir $(Build.SourcesDirectory)\.testresults\unit
    cargo junit --name $(Build.SourcesDirectory)\.testresults\unit\junit.xml
  displayName: 'Run tests'

- task: PublishTestResults@2
  displayName: 'Publish unit test results'
  inputs:
    testResultsFormat: JUnit
    testResultsFiles: 'junit.xml'
    searchFolder: $(Build.SourcesDirectory)/.testresults/unit
    testRunTitle: 'rust-hook::Unit Tests::Windows PR - Build $(Build.BuildId)'
